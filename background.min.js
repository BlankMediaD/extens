let popupWindowId=null;let currentQuery="";let currentStart=0;let isLastPage=false;let totalResults=0;let isActive=false;let isProLicenseActive=false;const MAX_TOTAL_RESULTS=500;let leadGenProcessCount=0;const MAX_FREE_PROCESS_COUNT=5;let searchTabIds=[];let captchaDetected=false;let lastSearchQuery="";let lastSearchStart=0;let captchaTabId=null;let captchaAutoSolveAttempted=false;chrome.runtime.onMessage.addListener(((request,sender,sendResponse)=>{if(request.action==="captchaDetected"){captchaDetected=true;captchaTabId=sender.tab.id;captchaAutoSolveAttempted=false;lastSearchQuery=currentQuery;lastSearchStart=currentStart;isActive=false;chrome.runtime.sendMessage({action:"captchaFound",url:request.url,tabId:sender.tab.id,autoSolving:true});chrome.tabs.update(sender.tab.id,{active:true})}else if(request.action==="captchaClickAttempt"){captchaAutoSolveAttempted=true;chrome.runtime.sendMessage({action:"captchaAutoClickAttempt"})}else if(request.action==="captchaAutoSolveSuccess"){captchaDetected=false;captchaAutoSolveAttempted=false;chrome.runtime.sendMessage({action:"captchaAutoSolveSuccess"});if(lastSearchQuery){setTimeout((()=>{isActive=true;currentQuery=lastSearchQuery;currentStart=lastSearchStart;chrome.runtime.sendMessage({action:"scrapingResumed"});searchNextPage()}),2e3)}}else if(request.action==="captchaAutoSolveFailed"){chrome.runtime.sendMessage({action:"captchaAutoSolveFailed",tabId:captchaTabId})}else if(request.action==="captchaSolved"){if(lastSearchQuery){captchaDetected=false;isActive=true;currentQuery=lastSearchQuery;currentStart=lastSearchStart;chrome.runtime.sendMessage({action:"scrapingResumed"});setTimeout(searchNextPage,1e3)}}else if(request.action==="searchAndScrape"){chrome.storage.sync.get(["licenseStatus","leadGenCount"],(result=>{isProLicenseActive=result.licenseStatus&&result.licenseStatus.isValid&&result.licenseStatus.isValid===true;leadGenProcessCount=result.leadGenCount||0;if(!isProLicenseActive&&leadGenProcessCount>=MAX_FREE_PROCESS_COUNT){chrome.runtime.sendMessage({action:"processLimitExceeded"});if(request.searchTabId){chrome.tabs.remove(request.searchTabId)}return}if(!isProLicenseActive){leadGenProcessCount++;chrome.storage.sync.set({leadGenCount:leadGenProcessCount})}if(request.dashboardTabId){popupWindowId=request.dashboardTabId}currentQuery=request.query;currentStart=0;isLastPage=false;totalResults=0;isActive=true;if(request.searchTabId){const searchUrl=`https://www.google.com/search?q=${encodeURIComponent(currentQuery)}&num=100&start=${currentStart}`;chrome.tabs.update(request.searchTabId,{url:searchUrl});if(!searchTabIds.includes(request.searchTabId)){searchTabIds.push(request.searchTabId)}if(popupWindowId){chrome.tabs.update(popupWindowId,{active:true})}}else{searchNextPage()}}))}else if(request.action==="scrapingResults"){if(!isActive)return;if(request.results.length>0){totalResults+=request.results.length;chrome.runtime.sendMessage({action:"displayResults",results:request.results,isProLicense:isProLicenseActive})}if(!isLastPage&&totalResults<MAX_TOTAL_RESULTS){setTimeout(searchNextPage,5e3)}else{chrome.runtime.sendMessage({action:"scrapingComplete"});resetState()}}else if(request.action==="noMoreResults"){isLastPage=true;chrome.runtime.sendMessage({action:"scrapingComplete"});resetState()}else if(request.action==="stopScraping"){resetState()}else if(request.action==="verifyLicense"){verifyLicense(request.licenseKey).then((response=>{if(response.isValid){chrome.storage.sync.set({licenseStatus:{isValid:true,verifiedAt:Date.now(),licenseKey:request.licenseKey,purchaseData:response.purchaseData}})}sendResponse(response)})).catch((error=>{sendResponse({isValid:false,error:error.message||"Verification failed"})}));return true}else if(request.action==="resetLeadGenCount"){chrome.storage.sync.set({leadGenCount:0});sendResponse({success:true})}}));function searchNextPage(){if(!isActive)return;chrome.tabs.query({url:"https://www.google.com/search*"},(tabs=>{const searchUrl=`https://www.google.com/search?q=${encodeURIComponent(currentQuery)}&num=100&start=${currentStart}`;if(tabs.length>0){chrome.tabs.update(tabs[0].id,{url:searchUrl});if(!searchTabIds.includes(tabs[0].id)){searchTabIds.push(tabs[0].id)}}else{chrome.tabs.create({url:searchUrl,active:false},(tab=>{searchTabIds.push(tab.id)}))}if(popupWindowId){chrome.tabs.update(popupWindowId,{active:true})}currentStart+=100}))}function resetState(){isActive=false;currentQuery="";currentStart=0;isLastPage=false;totalResults=0;popupWindowId=null;if(!captchaDetected){closeSearchTabs();searchTabIds=captchaDetected?[captchaTabId]:[]}else{closeSearchTabs()}}function closeSearchTabs(){if(searchTabIds.length>0){console.log("Closing search tabs:",searchTabIds);searchTabIds.forEach((tabId=>{if(captchaDetected&&tabId===captchaTabId){console.log("Keeping CAPTCHA tab open:",tabId);return}try{chrome.tabs.remove(tabId,(()=>{if(chrome.runtime.lastError){console.log("Error closing tab:",chrome.runtime.lastError)}}))}catch(error){console.error("Error closing tab:",error)}}))}if(captchaDetected&&captchaTabId){searchTabIds=searchTabIds.filter((id=>id===captchaTabId))}else{searchTabIds=[]}}chrome.tabs.onUpdated.addListener(((tabId,changeInfo,tab)=>{if(captchaDetected&&captchaTabId===tabId&&changeInfo.status==="complete"){if(tab.url.includes("google.com/search")&&!tab.url.includes("captcha")){chrome.runtime.sendMessage({action:"captchaSolved"});captchaDetected=false;captchaTabId=null;setTimeout((()=>{isActive=true;currentQuery=lastSearchQuery;currentStart=lastSearchStart;chrome.runtime.sendMessage({action:"scrapingResumed"});searchNextPage()}),2e3)}}if(isActive&&changeInfo.status==="complete"&&tab.url.includes("google.com/search")){chrome.scripting.executeScript({target:{tabId:tabId},files:["content.js"]},(()=>{chrome.tabs.sendMessage(tabId,{action:"scrape"});if(popupWindowId){setTimeout((()=>{chrome.tabs.update(popupWindowId,{active:true})}),500)}}))}}));chrome.runtime.onConnect.addListener((function(port){if(port.name==="popup"){port.onDisconnect.addListener((function(){resetState()}))}}));function verifyLicense(licenseKey){const productId="MZRHpNU2EHOPqMvcaDLOZg==";const apiUrl=`https://api.gumroad.com/v2/licenses/verify`;const formData=new URLSearchParams;formData.append("product_id",productId);formData.append("license_key",licenseKey);return fetch(apiUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:formData.toString()}).then((response=>response.json())).then((data=>{console.log("License Verification Response:",data);if(data.success){return{isValid:true,purchaseData:data.purchase}}else{throw new Error(data.message||"License verification failed")}})).catch((error=>{console.error("License verification error:",error);throw error}))}chrome.runtime.onInstalled.addListener((details=>{if(details.reason==="install"){chrome.tabs.create({url:"https://www.rovelin.com/Our-products"})}checkLicenseValidity();chrome.alarms.create("licenseCheck",{periodInMinutes:24*60})}));chrome.alarms.onAlarm.addListener((alarm=>{if(alarm.name==="licenseCheck"){checkLicenseValidity()}}));function checkLicenseValidity(){console.log("Checking license validity...");chrome.storage.sync.get(["licenseStatus"],(function(result){if(chrome.runtime.lastError){console.error("Error accessing storage:",chrome.runtime.lastError);return}if(result.licenseStatus&&result.licenseStatus.licenseKey){verifyLicense(result.licenseStatus.licenseKey).then((response=>{if(!response.isValid){console.log("License is no longer valid");chrome.storage.sync.remove(["licenseStatus"],(()=>{notifyLicenseExpired()}))}else{console.log("License is still valid");chrome.storage.sync.set({licenseStatus:{...result.licenseStatus,lastVerified:Date.now()}})}})).catch((error=>{console.error("License verification failed:",error);notifyLicenseError()}))}}))}function notifyLicenseExpired(){chrome.runtime.sendMessage({action:"licenseExpired",message:"Your license has expired. Please renew to continue using PRO features."});if(chrome.notifications){chrome.notifications.create("licenseExpired",{type:"basic",iconUrl:"img/icon48.png",title:"License Expired",message:"Your PRO license has expired. Please renew to continue using PRO features."})}}function notifyLicenseError(){chrome.runtime.sendMessage({action:"licenseError",message:"There was an error verifying your license. Please try again later."})}chrome.runtime.onStartup.addListener(checkLicenseValidity);chrome.runtime.setUninstallURL("https://www.rovelin.com/Our-products",(()=>{if(chrome.runtime.lastError){console.error("Error setting uninstall URL:",chrome.runtime.lastError)}}));chrome.action.onClicked.addListener((tab=>{chrome.tabs.create({url:"dashboard.html"})}));